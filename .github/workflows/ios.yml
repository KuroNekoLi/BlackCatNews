name: iOS CI/CD (Fastlane)

on:
  push:
    branches:
      - main
      - develop
      - 'feature/*'
      - 'bugfix/*'
    tags:
      - 'ios-alpha-v*'
      - 'ios-beta-v*'
      - 'ios-v*'
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:
    inputs:
      lane:
        description: "Fastlane lane to run (beta/release)"
        required: false
        default: beta

jobs:
  ios:
    runs-on: macos-15

    env:
      # App Store Connect API Keyï¼ˆæ“‡ä¸€æä¾›ï¼šASC_PRIVATE_KEY æˆ– ASC_PRIVATE_KEY_BASE64ï¼‰
      ASC_KEY_ID: ${{ secrets.ASC_KEY_ID }}
      ASC_ISSUER_ID: ${{ secrets.ASC_ISSUER_ID }}
      ASC_PRIVATE_KEY: ${{ secrets.ASC_PRIVATE_KEY }}
      ASC_PRIVATE_KEY_BASE64: ${{ secrets.ASC_PRIVATE_KEY_BASE64 }}

      # iOS Distribution æ†‘è­‰ï¼ˆp12ï¼‰
      IOS_DIST_CERT_BASE64: ${{ secrets.IOS_DIST_CERT_BASE64 }}
      IOS_DIST_CERT_PASSWORD: ${{ secrets.IOS_DIST_CERT_PASSWORD }}

      #ï¼ˆå¯é¸ï¼‰ä½ çš„ Apple Team IDï¼Œä¾› Fastlane update_code_signing_settings ä½¿ç”¨
      APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Cache Kotlin/Native (.konan)
        uses: actions/cache@v4
        with:
          path: |
            ~/.konan
          key: ${{ runner.os }}-konan-${{ hashFiles('gradle.properties') }}
          restore-keys: |
            ${{ runner.os }}-konan-

      - name: Select Xcode 16
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '16.*'

      - name: Set up Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      # Gradle å®˜æ–¹å¿«å–ï¼ˆç›¸ä¾èˆ‡ build cacheï¼‰
      - name: Set up Gradle (with cache)
        uses: gradle/actions/setup-gradle@v4

      # Ruby + Bundler å¿«å–ï¼ˆå–ä»£æ‰‹å‹•å®‰è£èˆ‡ç¨ç«‹ gems cacheï¼‰
      - name: Setup Ruby & bundle (with cache)
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.3'
          bundler-cache: true
          working-directory: iosApp/fastlane

      - name: Cache CocoaPods
        uses: actions/cache@v4
        with:
          path: |
            iosApp/Pods
            ~/Library/Caches/CocoaPods
            ~/.cocoapods
          key: ${{ runner.os }}-pods-${{ hashFiles('iosApp/Podfile.lock') }}
          restore-keys: |
            ${{ runner.os }}-pods-

      - name: Cache Xcode DerivedData
        uses: actions/cache@v4
        with:
          path: |
            ~/Library/Developer/Xcode/DerivedData
          key: ${{ runner.os }}-xcode-deriveddata-${{ hashFiles('iosApp/Podfile.lock','iosApp/**/*.swift','iosApp/**/*.m','iosApp/**/*.h','iosApp/*.xcodeproj/project.pbxproj','iosApp/*.xcworkspace/contents.xcworkspacedata') }}
          restore-keys: |
            ${{ runner.os }}-xcode-deriveddata-

      # CocoaPodsï¼ˆè‹¥ runner å°šæœªè£ï¼Œå®‰è£ä¸€æ¬¡ï¼‰
      - name: Ensure CocoaPods Installed
        run: pod --version || sudo gem install cocoapods --no-document


      # ä¾ ref æ±ºå®šæ˜¯å¦è¦ä¸Šå‚³ TestFlightï¼ˆä¸é€å¯©ï¼‰
      - name: Decide lane and flags
        id: decide
        shell: bash
        run: |
          REF='${{ github.ref_name }}'
          if [[ '${{ github.event_name }}' == 'push' && '${{ github.ref_type }}' == 'branch' ]]; then
            BRANCH="${{ github.ref_name }}"
            if [[ "$BRANCH" == 'main' || "$BRANCH" == 'develop' ]]; then
              LANE='beta'; DEPLOY=true; USE_PROJECT_VERSION=false; TARGET_VERSION=''
            else
              LANE='build_only'; DEPLOY=false; USE_PROJECT_VERSION=false; TARGET_VERSION=''
            fi
          elif [[ '${{ github.ref_type }}' == 'tag' && "$REF" == ios-* ]]; then
            LANE='beta'; DEPLOY=true; USE_PROJECT_VERSION=false; TARGET_VERSION="${REF#ios-}"
          elif [[ '${{ github.event_name }}' == 'pull_request' ]]; then
            LANE='build_only'; DEPLOY=false; USE_PROJECT_VERSION=false; TARGET_VERSION=''
          else
            LANE='${{ github.event.inputs.lane || 'beta' }}'
            DEPLOY=true; USE_PROJECT_VERSION=false; TARGET_VERSION=''
          fi
          echo "lane=$LANE"   >> $GITHUB_OUTPUT
          echo "deploy=$DEPLOY" >> $GITHUB_OUTPUT
          echo "use_project_version=$USE_PROJECT_VERSION" >> $GITHUB_OUTPUT
          echo "target_version=$TARGET_VERSION" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ Lane: $LANE Deploy: $DEPLOY Target: $TARGET_VERSION"



      - name: Build and upload via Fastlane
        if: steps.decide.outputs.deploy == 'true'
        working-directory: iosApp
        env:
          TARGET_VERSION: ${{ steps.decide.outputs.target_version }}
          USE_PROJECT_VERSION: ${{ steps.decide.outputs.use_project_version }}
        run: |
          echo "lane=${{ steps.decide.outputs.lane }} (TestFlight upload enabled)"
          BUNDLE_GEMFILE=fastlane/Gemfile bundle exec fastlane ${{ steps.decide.outputs.lane }}

      - name: Build only (no upload)
        if: steps.decide.outputs.deploy == 'false'
        working-directory: iosApp
        env:
          TARGET_VERSION: ${{ steps.decide.outputs.target_version }}
          USE_PROJECT_VERSION: ${{ steps.decide.outputs.use_project_version }}
        run: |
          echo "ðŸ”¨ Building only (no TestFlight upload)"
          BUNDLE_GEMFILE=fastlane/Gemfile bundle exec fastlane build_only

      - name: Upload ipa artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ios-ipa
          path: iosApp/*.ipa
