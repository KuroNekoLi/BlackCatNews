name: Android Play Deploy (GPP)

on:
  push:
    branches: [ main ]          # åªæœ‰ main æ‰è‡ªå‹•ä¸Šå‚³åˆ° internal
    tags:
      - 'android-alpha-v*'      # å°é–‰æ¸¬è©¦ï¼ˆå¦‚ android-alpha-v1.0.0ï¼‰
      - 'android-beta-v*'       # å…¬é–‹æ¸¬è©¦ï¼ˆå¦‚ android-beta-v1.0.0ï¼‰
      - 'android-v*'            # æ­£å¼ç‰ˆï¼ˆå¦‚ android-v1.0.0ï¼‰
      - 'v*.*.*'                # ç‰ˆæœ¬è™Ÿ tag ä¹Ÿå¯è§¸ç™¼
  pull_request:
    branches: [ main ]          # PR åˆ° main æ™‚åªå»ºç½®é©—è­‰ï¼Œä¸ä¸Šå‚³
  workflow_dispatch: # æ‰‹å‹•è§¸ç™¼ï¼šå¯é¸æ“‡ä»»æ„è»Œé“
    inputs:
      track:
        description: "Play Console è»Œé“"
        type: choice
        options:
          - internal
          - alpha
          - beta
          - production
        default: internal
        required: true

jobs:
  publish:
    runs-on: ubuntu-latest
    
    env:
      # Play Console æ†‘è­‰ï¼ˆä½¿ç”¨åŸå§‹ JSONï¼Œå¤šè¡Œï¼‰
      PLAY_CREDENTIALS_JSON: ${{ secrets.PLAY_CREDENTIALS_JSON }}
      # Release ç°½ç« ç’°å¢ƒè®Šæ•¸
      UPLOAD_KEYSTORE: ${{ github.workspace }}/upload-keystore.jks
      UPLOAD_KEYSTORE_PASSWORD: ${{ secrets.UPLOAD_KEYSTORE_PASSWORD }}
      UPLOAD_KEY_ALIAS: ${{ secrets.UPLOAD_KEY_ALIAS }}
      UPLOAD_KEY_PASSWORD: ${{ secrets.UPLOAD_KEY_PASSWORD }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Gradle cache
        uses: gradle/actions/setup-gradle@v3

      - name: Restore Upload Keystore
        run: |
          echo "${{ secrets.UPLOAD_KEYSTORE_BASE64 }}" | base64 --decode > upload-keystore.jks
          echo "âœ… Keystore å·²é‚„åŸ"

      - name: Determine track
        id: track
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            # æ‰‹å‹•è§¸ç™¼ï¼šä½¿ç”¨ä½¿ç”¨è€…é¸æ“‡çš„è»Œé“
            TRACK="${{ github.event.inputs.track }}"
          elif [ "${{ github.ref_type }}" == "tag" ]; then
            # Tag è§¸ç™¼ï¼šæ ¹æ“š tag åç¨±æ±ºå®šè»Œé“
            TAG_NAME="${{ github.ref_name }}"
            if [[ "$TAG_NAME" == android-alpha-v* ]]; then
              TRACK="alpha"      # å°é–‰æ¸¬è©¦
            elif [[ "$TAG_NAME" == android-beta-v* ]]; then
              TRACK="beta"       # å…¬é–‹æ¸¬è©¦
            elif [[ "$TAG_NAME" == android-v* ]]; then
              TRACK="production" # æ­£å¼ç‰ˆ
            elif [[ "$TAG_NAME" == v*.*.* ]]; then
              TRACK="beta"       # ç‰ˆæœ¬è™Ÿ tag é è¨­å…¬é–‹æ¸¬è©¦
            else
              TRACK="internal"   # é è¨­
            fi
          else
            # Push to mainï¼šå…§éƒ¨æ¸¬è©¦
            TRACK="internal"
          fi
          echo "track=${TRACK}" >> $GITHUB_OUTPUT
          echo "ğŸ“¦ ç›®æ¨™è»Œé“: ${TRACK}"

      - name: Determine version code
        id: version
        run: |
          # è¨ˆç®—åŸºç¤ç‰ˆæœ¬è™Ÿï¼ˆrun_number + 100ï¼‰
          BASE_VERSION_CODE=$((100 + ${{ github.run_number }}))
          VERSION_NAME="1.0.$BASE_VERSION_CODE"
          
          echo "version_code=$BASE_VERSION_CODE" >> $GITHUB_OUTPUT
          echo "version_name=$VERSION_NAME" >> $GITHUB_OUTPUT
          echo "ğŸ“¦ åˆå§‹ç‰ˆæœ¬è™Ÿï¼šversionCode=$BASE_VERSION_CODE, versionName=$VERSION_NAME"

      - name: Build AAB (release)
        env:
          VERSION_CODE: ${{ steps.version.outputs.version_code }}
          VERSION_NAME: ${{ steps.version.outputs.version_name }}
        run: |
          echo "ğŸ“¦ å»ºç½®ç‰ˆæœ¬ï¼šversionCode=$VERSION_CODE, versionName=$VERSION_NAME"
          ./gradlew :composeApp:bundleRelease --stacktrace

      - name: Publish to Play Console
        if: github.event_name != 'pull_request'  # PR æ™‚ä¸ä¸Šå‚³ï¼Œåªå»ºç½®é©—è­‰
        id: publish
        continue-on-error: true
        run: |
          TRACK=${{ steps.track.outputs.track }}
          echo "ğŸš€ ä¸Šå‚³åˆ°è»Œé“: ${TRACK}"
          ./gradlew :composeApp:publishReleaseBundle --track ${TRACK} --stacktrace

      - name: Retry with incremented version (if failed)
        if: github.event_name != 'pull_request' && steps.publish.outcome == 'failure'
        run: |
          echo "âš ï¸  ä¸Šå‚³å¤±æ•—ï¼Œå¯èƒ½æ˜¯ç‰ˆæœ¬è™Ÿè¡çª"
          echo "ğŸ”„ é‡æ–°å»ºç½®ä¸¦éå¢ç‰ˆæœ¬è™Ÿ..."
          
          # éå¢ç‰ˆæœ¬è™Ÿ
          NEW_VERSION_CODE=$(($(echo "${{ steps.version.outputs.version_code }}") + 1))
          NEW_VERSION_NAME="1.0.$NEW_VERSION_CODE"
          
          echo "ğŸ“¦ æ–°ç‰ˆæœ¬è™Ÿï¼šversionCode=$NEW_VERSION_CODE, versionName=$NEW_VERSION_NAME"
          
          # é‡æ–°å»ºç½®
          export VERSION_CODE=$NEW_VERSION_CODE
          export VERSION_NAME=$NEW_VERSION_NAME
          ./gradlew :composeApp:bundleRelease --stacktrace
          
          # é‡æ–°ä¸Šå‚³
          TRACK=${{ steps.track.outputs.track }}
          echo "ğŸš€ é‡æ–°ä¸Šå‚³åˆ°è»Œé“: ${TRACK}"
          ./gradlew :composeApp:publishReleaseBundle --track ${TRACK} --stacktrace

      - name: Upload AAB artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: app-release-aab-${{ steps.track.outputs.track }}
          path: composeApp/build/outputs/bundle/release/composeApp-release.aab
