name: Android Play Deploy (GPP)

on:
  push:
    branches: [ main ]          # è‡ªå‹•ä¸Šå‚³åˆ° internalï¼ˆå…§éƒ¨æ¸¬è©¦ï¼‰
    tags:
      - 'android-alpha-v*'      # å°é–‰æ¸¬è©¦ï¼ˆå¦‚ android-alpha-v1.0.0ï¼‰
      - 'android-beta-v*'       # å…¬é–‹æ¸¬è©¦ï¼ˆå¦‚ android-beta-v1.0.0ï¼‰
      - 'android-v*'            # æ­£å¼ç‰ˆï¼ˆå¦‚ android-v1.0.0ï¼‰
      - 'v*.*.*'                # ç‰ˆæœ¬è™Ÿ tag ä¹Ÿå¯è§¸ç™¼
  workflow_dispatch: # æ‰‹å‹•è§¸ç™¼ï¼šå¯é¸æ“‡ä»»æ„è»Œé“
    inputs:
      track:
        description: "Play Console è»Œé“"
        type: choice
        options:
          - internal
          - alpha
          - beta
          - production
        default: internal
        required: true

jobs:
  publish:
    runs-on: ubuntu-latest
    
    env:
      # Release ç°½ç« ç’°å¢ƒè®Šæ•¸
      UPLOAD_KEYSTORE: ${{ github.workspace }}/upload-keystore.jks
      UPLOAD_KEYSTORE_PASSWORD: ${{ secrets.UPLOAD_KEYSTORE_PASSWORD }}
      UPLOAD_KEY_ALIAS: ${{ secrets.UPLOAD_KEY_ALIAS }}
      UPLOAD_KEY_PASSWORD: ${{ secrets.UPLOAD_KEY_PASSWORD }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Gradle cache
        uses: gradle/actions/setup-gradle@v3

      - name: Restore Upload Keystore
        run: |
          echo "${{ secrets.UPLOAD_KEYSTORE_BASE64 }}" | base64 --decode > upload-keystore.jks
          echo "âœ… Keystore å·²é‚„åŸ"

      - name: Write Play credentials
        run: |
          echo "${{ secrets.PLAY_CREDENTIALS_JSON_B64 }}" | base64 --decode > play-credentials.json
          echo "âœ… Play credentials å·²é‚„åŸ"

      - name: Determine track
        id: track
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            # æ‰‹å‹•è§¸ç™¼ï¼šä½¿ç”¨ä½¿ç”¨è€…é¸æ“‡çš„è»Œé“
            TRACK="${{ github.event.inputs.track }}"
          elif [ "${{ github.ref_type }}" == "tag" ]; then
            # Tag è§¸ç™¼ï¼šæ ¹æ“š tag åç¨±æ±ºå®šè»Œé“
            TAG_NAME="${{ github.ref_name }}"
            if [[ "$TAG_NAME" == android-alpha-v* ]]; then
              TRACK="alpha"      # å°é–‰æ¸¬è©¦
            elif [[ "$TAG_NAME" == android-beta-v* ]]; then
              TRACK="beta"       # å…¬é–‹æ¸¬è©¦
            elif [[ "$TAG_NAME" == android-v* ]]; then
              TRACK="production" # æ­£å¼ç‰ˆ
            elif [[ "$TAG_NAME" == v*.*.* ]]; then
              TRACK="beta"       # ç‰ˆæœ¬è™Ÿ tag é è¨­å…¬é–‹æ¸¬è©¦
            else
              TRACK="internal"   # é è¨­
            fi
          else
            # Push to mainï¼šå…§éƒ¨æ¸¬è©¦
            TRACK="internal"
          fi
          echo "track=${TRACK}" >> $GITHUB_OUTPUT
          echo "ğŸ“¦ ç›®æ¨™è»Œé“: ${TRACK}"

      - name: Build AAB (release)
        run: |
          # è¨ˆç®—ç‰ˆæœ¬è™Ÿï¼ˆrun_number + 100ï¼Œé¿å…èˆ‡æ‰‹å‹•ç‰ˆæœ¬è¡çªï¼‰
          VERSION_CODE=$((100 + ${{ github.run_number }}))
          VERSION_NAME="1.0.${{ github.run_number }}"
          echo "ğŸ“¦ ç‰ˆæœ¬è™Ÿï¼šversionCode=${VERSION_CODE}, versionName=${VERSION_NAME}"
          export VERSION_CODE
          export VERSION_NAME
          ./gradlew :composeApp:bundleRelease --stacktrace

      - name: Publish to Play Console
        run: |
          TRACK=${{ steps.track.outputs.track }}
          echo "ğŸš€ ä¸Šå‚³åˆ°è»Œé“: ${TRACK}"
          ./gradlew :composeApp:publishReleaseBundle --track ${TRACK} --stacktrace

      - name: Upload AAB artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: app-release-aab-${{ steps.track.outputs.track }}
          path: composeApp/build/outputs/bundle/release/composeApp-release.aab
