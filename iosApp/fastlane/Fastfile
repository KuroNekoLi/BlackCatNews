require "securerandom"
require "base64"

default_platform(:ios)

platform :ios do
  
  desc "Build ipa for App Store distribution"
  lane :build do
    # æª¢æŸ¥æ˜¯å¦æœ‰ App Store Connect API Key
    api_key = nil
    if ENV["ASC_KEY_ID"] && ENV["ASC_ISSUER_ID"] && ENV["ASC_PRIVATE_KEY"]
      puts "ğŸ”‘ ä½¿ç”¨ App Store Connect API Key èªè­‰"
      api_key = app_store_connect_api_key(
        key_id: ENV["ASC_KEY_ID"],
        issuer_id: ENV["ASC_ISSUER_ID"],
        key_content: ENV["ASC_PRIVATE_KEY"],
        is_key_content_base64: ENV["ASC_PRIVATE_KEY_BASE64"] == "true"
      )
    else
      puts "ğŸ”‘ ä½¿ç”¨ Apple ID + Session èªè­‰"
      if ENV["FASTLANE_USER"].nil? || ENV["FASTLANE_SESSION"].nil?
        UI.user_error!("è«‹è¨­å®š FASTLANE_USER å’Œ FASTLANE_SESSION ç’°å¢ƒè®Šæ•¸")
      end
    end

    # åœ¨ CI ç’°å¢ƒä¸­ä½¿ç”¨æ‰‹å‹•ç°½ç« 
    if ENV["CI"] || ENV["GITHUB_ACTIONS"]
      puts "ğŸ“± CI ç’°å¢ƒï¼šä½¿ç”¨æ‰‹å‹•ç°½ç« "
      
      if api_key.nil?
        UI.user_error!("CI ç’°å¢ƒéœ€è¦ App Store Connect API Key")
      end
      
      # å‰µå»ºè‡¨æ™‚ keychain ä»¥é¿å…ç°½ç« å¡ä½
      keychain_name = "fastlane_tmp_keychain"
      keychain_password = SecureRandom.uuid
      
      puts "ğŸ” å‰µå»ºè‡¨æ™‚ keychain: #{keychain_name}"
      
      # é è¨­ä¸€æ¢çµ•å°è·¯å¾‘ï¼ˆç¨å¾Œæœƒåµæ¸¬å¯¦éš›å­˜åœ¨çš„æª”æ¡ˆï¼‰
      keychain_path = File.expand_path("~/Library/Keychains/#{keychain_name}-db")
      
      create_keychain(
        name: keychain_name,
        password: keychain_password,
        default_keychain: true,
        unlock: true,
        timeout: 3600,  # 1 å°æ™‚å¾Œè‡ªå‹•é–å®š
        lock_when_sleeps: false
      )
      
      # å˜—è©¦åµæ¸¬å¯¦éš›å»ºç«‹çš„ keychain æª”æ¡ˆåç¨±ï¼ˆä¸åŒ macOS å¯èƒ½ç‚º -dbã€.keychain-db æˆ– .keychainï¼‰
      keychain_candidates = [
        File.expand_path("~/Library/Keychains/#{keychain_name}-db"),
        File.expand_path("~/Library/Keychains/#{keychain_name}.keychain-db"),
        File.expand_path("~/Library/Keychains/#{keychain_name}.keychain")
      ]
      detected_path = keychain_candidates.find { |p| File.exist?(p) }
      keychain_path = detected_path || keychain_path
      
      # å„ªå…ˆå¾ CI Secrets åŒ¯å…¥æ—¢æœ‰ Distribution æ†‘è­‰ï¼ˆé¿å…è§¸ç™¼å»ºç«‹æ–°æ†‘è­‰è€Œé”åˆ°ä¸Šé™ï¼‰
      certificate_imported = false
      if ENV["IOS_DIST_CERT_BASE64"] || ENV["IOS_DIST_CERT_PATH"]
        cert_path = ENV["IOS_DIST_CERT_PATH"]
        if cert_path.nil? || cert_path.empty?
          cert_path = File.join(Dir.pwd, "dist_cert.p12")
          File.binwrite(cert_path, Base64.decode64(ENV["IOS_DIST_CERT_BASE64"]))
        end
        cert_password = ENV["IOS_DIST_CERT_PASSWORD"] || ""
        puts "ğŸ” åŒ¯å…¥ Distribution æ†‘è­‰åˆ°è‡¨æ™‚ keychain"
        import_certificate(
          certificate_path: cert_path,
          certificate_password: cert_password,
          keychain_path: keychain_path,
          keychain_password: keychain_password
        )
        certificate_imported = true
      end

      unless certificate_imported
        UI.user_error!(
          "CI æœªæä¾› Distribution æ†‘è­‰ï¼ˆp12ï¼‰ã€‚è«‹æ–¼ GitHub Secrets è¨­å®š IOS_DIST_CERT_BASE64 èˆ‡ IOS_DIST_CERT_PASSWORDï¼Œ" \
          + "æˆ–æ”¹ç”¨ fastlane match ä¾†å®‰è£ç°½ç« æ†‘è­‰èˆ‡æè¿°æª”ã€‚"
        )
      end

      # ä½¿ç”¨ sigh ä¸‹è¼‰ App Store æè¿°æª”
      sigh_result = sigh(
        api_key: api_key,
        app_identifier: "com.linli.blackcatnews",
        force: true
      )
      
      # å¾ sigh çµæœç²å–æè¿°æª” UUID
      profile_uuid = lane_context[SharedValues::SIGH_UUID]
      profile_name = lane_context[SharedValues::SIGH_NAME]
      cert_id = lane_context[SharedValues::CERT_CERTIFICATE_ID]
      
      puts "ğŸ“‹ ä½¿ç”¨æè¿°æª”: #{profile_name} (#{profile_uuid})"
      puts "ğŸ” ä½¿ç”¨æ†‘è­‰: #{cert_id}"
      
      # æ‰‹å‹•ç°½ç« è¨­å®š - ä½¿ç”¨ UUID
      export_opts = {
        method: "app-store",
        signingStyle: "manual",
        provisioningProfiles: {
          "com.linli.blackcatnews" => profile_uuid
        }
      }
      
      # å¼·åˆ¶è¦†è“‹ Xcode å°ˆæ¡ˆè¨­å®šçš„ xcargs - æ³¨æ„å¼•è™Ÿçš„æ­£ç¢ºä½¿ç”¨
      xcargs = [
        "-allowProvisioningUpdates",
        "CODE_SIGN_STYLE=Manual",
        "CODE_SIGN_IDENTITY='iPhone Distribution'",
        "PROVISIONING_PROFILE=#{profile_uuid}",
        "DEVELOPMENT_TEAM=",
        "OTHER_CODE_SIGN_FLAGS='--keychain #{keychain_path}'"  # æŒ‡å®šä½¿ç”¨çš„ keychain
      ].join(" ")
    else
      puts "ğŸ–¥ï¸ æœ¬æ©Ÿç’°å¢ƒï¼šä½¿ç”¨ Xcode è‡ªå‹•ç°½ç« "
      export_opts = {
        signingStyle: "automatic"
      }
      
      # å¦‚æœæœ‰è¨­å®š Team IDï¼ŒåŠ å…¥åˆ° export options
      team_id = ENV["APPLE_TEAM_ID"] || ENV["FASTLANE_TEAM_ID"]
      export_opts[:teamID] = team_id if team_id && !team_id.empty?
      
      xcargs = ""
      keychain_name = nil
    end

    gym(
      workspace: "iosApp.xcworkspace",
      scheme: "iosApp",
      configuration: "Release",
      export_method: "app-store",
      clean: true,
      include_bitcode: false,
      export_options: export_opts,
      xcargs: xcargs,
      output_directory: ".",
      output_name: "BlackCatNews"
    )
    
    # CI ç’°å¢ƒï¼šæ¸…ç†è‡¨æ™‚ keychain
    if (ENV["CI"] || ENV["GITHUB_ACTIONS"]) && keychain_name
      puts "ğŸ—‘ï¸ åˆªé™¤è‡¨æ™‚ keychain: #{keychain_name}"
      delete_keychain(name: keychain_name)
    end
  end

  desc "Upload to TestFlight"
  lane :beta do
    build
    
    # æª¢æŸ¥æ˜¯å¦æœ‰ API Key
    if ENV["ASC_KEY_ID"] && ENV["ASC_ISSUER_ID"] && ENV["ASC_PRIVATE_KEY"]
      api_key = app_store_connect_api_key(
        key_id: ENV["ASC_KEY_ID"],
        issuer_id: ENV["ASC_ISSUER_ID"],
        key_content: ENV["ASC_PRIVATE_KEY"],
        is_key_content_base64: ENV["ASC_PRIVATE_KEY_BASE64"] == "true"
      )
      
      pilot(
        api_key: api_key,
        ipa: "BlackCatNews.ipa",
        skip_waiting_for_build_processing: false
      )
    else
      # ä½¿ç”¨ Apple ID è·¯å¾‘
      pilot(
        ipa: "BlackCatNews.ipa",
        skip_waiting_for_build_processing: false
      )
    end
  end

  desc "Upload to App Store Connect (ä¸è‡ªå‹•é€å¯©)"
  lane :release do
    build
    
    # è®€å–ç’°å¢ƒè®Šæ•¸æ§åˆ¶é€å¯©èˆ‡ä¸Šæ¶
    submit_for_review = ENV["SUBMIT_FOR_REVIEW"] == "true"
    automatic_release = ENV["AUTOMATIC_RELEASE"] == "true"
    
    # æª¢æŸ¥æ˜¯å¦æœ‰ API Key
    if ENV["ASC_KEY_ID"] && ENV["ASC_ISSUER_ID"] && ENV["ASC_PRIVATE_KEY"]
      api_key = app_store_connect_api_key(
        key_id: ENV["ASC_KEY_ID"],
        issuer_id: ENV["ASC_ISSUER_ID"],
        key_content: ENV["ASC_PRIVATE_KEY"],
        is_key_content_base64: ENV["ASC_PRIVATE_KEY_BASE64"] == "true"
      )
      
      deliver(
        api_key: api_key,
        ipa: "BlackCatNews.ipa",
        submit_for_review: submit_for_review,
        automatic_release: automatic_release,
        skip_metadata: true,
        skip_screenshots: true,
        force: true
      )
    else
      # ä½¿ç”¨ Apple ID è·¯å¾‘
      deliver(
        ipa: "BlackCatNews.ipa",
        submit_for_review: submit_for_review,
        automatic_release: automatic_release,
        skip_metadata: true,
        skip_screenshots: true,
        force: true
      )
    end
  end

end
